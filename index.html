<HTML>
<head>
    <!--This is important! needs to be UTF-8 to be compatible with adobe acceptable text-->
    <!-- python -m http.server 8021 --cgi -->
    <meta charset="UTF-8">
<title>
    Bullets Viewer
</title>
<script type="text/javascript" src="pdf.js"></script>
<script type="text/javascript" src="import-bullets.js"></script>
<script type="text/javascript" src="bullet-fixer.js"></script>
<script type="text/javascript" src="./replaceTables.js"></script>
<script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/handsontable@7.2.2/dist/handsontable.full.min.css" rel="stylesheet" media="screen">
<script lang="javascript" src="xlsx.full.min.js"></script>
<style type="text/css">
@font-face {
  font-family: "AdobeTimes";
  src: url("./TimesNewRomanPSMT.ttf");
}
textarea.bullets{
    margin: 0px;
    height: 500px;
    white-space: pre-wrap;
    text-indent: 0px;
    overflow: hidden;
    border: none;
    padding-left: 0px;
    resize: none;
    /*word-break: break-all;*/
    text-rendering: geometricPrecision;
}
.border{
    border: solid black 1px;
    display: inline-block;
    margin:10px;
    vertical-align:top;
    
}
form{
    margin:10px
}
#processedBullets{
    display:inline-block;
    vertical-align:top;
}
.bullets{
    font-family: "AdobeTimes";
    font-size: 12pt;
    white-space:pre-wrap;
    display:inline;
    text-rendering: geometricPrecision;
}
input.htCheckboxRendererInput{
    margin: 2px auto!important;
    display:block!important;
}
#thesaurus{

    width:500px;
    float:left;
    
}
#thesaurus > ul {
    columns:3;
    list-style-type:circle;
}
#abbrTable{
    margin:10px;
}

</style>



<script type="text/javascript">
function selectText(containerid) {
    if (window.getSelection) { 
        //this does not work with IE. oh well, I removed IE support. If you want to add it back in, go back several commits and you will see IE implementation.
        var range = document.createRange();
        range.selectNode(document.getElementById(containerid));
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
    }
}
updateWidth = function(){
        newWidth = document.getElementById("bulletInputSize").value + 'mm';
        document.getElementById("bulletInput").style.width = newWidth;        
}

updateProcessedBullets = function(){
    var rawBulletStr = document.getElementById("bulletInput").value;
    var rawBullets = rawBulletStr.split('\n');
    var outputWrapper = document.getElementById('outputBorder');
    outputWrapper.innerHTML = ''; //clear out 
    
    updateDict('bulletInput');
    var optimWidth = document.getElementById("bulletInputSize").value + 'mm';

    for (var bullet of rawBullets){

        bullet = replaceAbbrs(bullet);
        console.log('bullet: "' + bullet + '"')
        var bulletObj = new Bullet(bullet);
        var alreadyThere = bulletDict[sentence2Key(bullet)];
        
        //console.log(alreadyThere)
        if(alreadyThere && alreadyThere.optimization.width == optimWidth && alreadyThere.optimization.status >= 0){
            bulletObj.optimization = bulletDict[sentence2Key(bullet)].optimization;
            
        }else{
            bulletObj.optimizeSpacings(optimWidth);
            bulletDict[sentence2Key(bullet)] = {
                'optimization': bulletObj.optimization
            };
            //console.log(bulletDict[sentence2Key(bullet)])
        }
        bulletObj.post(outputWrapper);
    }
}

//technically not a cookie, but localStorage now.
function saveCookie(){
    cookieData = encodeURIComponent(
        document.getElementById('bulletInput').value
        );
    //console.log(cookieData);
    //document.cookie = cookieData +  '; expires=Thu, 18 Dec 3000 12:00:00 UTC; path=/';
    try{
        localStorage.setItem('bullets',cookieData)
        console.log("saved to local storage with character length " + cookieData.length);
    }catch(err){
        if(err.name == 'SecurityError'){
            alert("Sorry, saving to cookies does not work using the file:// interface and your browser's privacy settings")
        }else{
            throw err;
        }
    }
}


function importPdf(){
    if(!document.getElementById("importPdf").value){
        console.log('no file picked');
        return;
    }
    work = getBulletsFromPdf(document.getElementById("importPdf").files[0]);

    work.pullBullets.then(function(bullets){
        //console.log(bullets);
        
        //if I use innerHTML, the textarea doesn't update sometimes.
        // if I set the value to the bullet string, it parses it as HTML and includes things like &amp;
        // so I needed to parse it as actual HTML and get the resulting text.
        document.getElementById("bulletInput").value = 
            new DOMParser().parseFromString(bullets,'text/html').documentElement.textContent;
        //console.log(bullets)
        work.getPageInfo.then(function(data){
            console.log(data)
            document.getElementById("bulletInputSize").value = data.width.replace(/mm/,'');
            document.getElementById("bulletInputSize").oninput();
            
        });
    });
}

function importAbbrs(useDefault){

    if(useDefault){
        
        var xhttp = new XMLHttpRequest();
        xhttp.open('GET','https://ea-pods-team.github.io/pdf-bullets/abbrs.xlsx');
        xhttp.responseType = 'blob';
        xhttp.onload = function(){
            var abbrFile = xhttp.response;
            getDataFromXLS(abbrFile)
        }
        xhttp.send()
    }else{
        if(!document.getElementById("importAbbrs").value){
            console.log('no file picked');
            return;
        }
        var abbrFile = document.querySelector('#importAbbrs').files[0]
        getDataFromXLS(abbrFile)
    }
}

function getDataFromXLS(file){
    var reader = new FileReader();
    reader.onload = function(event){
        var data = event.target.result;
        var workbook = XLSX.read(data,{
            type:'binary',
            raw:true,
        });
        var rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]],
            {'header':['enabled','value','abbr']});
        window.abbrTable.clear();
        window.abbrTable.loadData(rows);
        
    };
    reader.readAsBinaryString(file)
}

function getThesaurus(){
    
    
    var sel = window.getSelection();
    //console.log(sel)
    if(sel.anchorNode.id == 'bulletsBorder' || sel.anchorNode.parentNode.className == 'bullets'){
        var phrase = sel.toString().trim();
        if(phrase && phrase != window.thesaurusPhrase){
            console.log('valid selection: ' + phrase);
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if(this.readyState == 4 && this.status == 200){
                    var dat = JSON.parse(this.responseText);
                    //console.log(dat);
                    document.querySelector('#thesaurus').innerHTML = ''
                    var list = document.createElement('ul');
                    document.querySelector('#thesaurus').appendChild(list);
                    for (var i of dat){
                        var wordNode = document.createElement("li");
                        
                        wordNode.innerText = i.word;
                        list.appendChild(wordNode);
                    }
                    if(dat.length == 0){
                        document.querySelector('#thesaurus').innerText =  'no results found.'
                    }
                    
                }
            }

            xhttp.open("GET","https://api.datamuse.com/words?max=75&ml=" + phrase,true)

            xhttp.send();
            document.querySelector('#thesaurus').innerText = 'loading...';
            //lookup new phrase
            window.thesaurusPhrase = phrase;

        }
    }
   
}
function autoResizeTextArea(id){
    ta = document.getElementById(id);
    ta.style.height = 'auto';
    ta.style.height = ta.scrollHeight + 'px';
}
window.onload = function(e){
    //This function runs when the window is finished loading. sort of like a main()

    //initialize a default width for the textarea window
    //document.getElementById("bulletInputSize").value = 202.321;
    document.getElementById("bulletInputSize").value = 202.51;
    document.getElementById("bulletInput").value = '\
- Led 3-member crack software team; wrote 2K+ lines of code in 3 weeks-- boosted AF literary efficiency by 9000%\n\
- Developed advanced text analysis program; parsed/formatted 10,000 event parameters--saved AF $5bn in time savings';

    window.bulletDict = {};
    window.abbrDict = {};
    window.thesaurusPhrase = '';
    try{
        if(localStorage.getItem('bullets')){
            var text = decodeURIComponent(localStorage.getItem("bullets")).trim();
            if(text){
                document.getElementById("bulletInput").value = text;
            }
        }
    }catch(err){
        if(err.name == 'SecurityError'){
            console.log('Was not able to get localstorage bullets due to use of file interface and browser privacy settings')
        }else{
            throw err;
        }
    }

    
    initTables();
    updateWidth();
    updateProcessedBullets();
    
    document.getElementById("bulletInputSize").oninput = function(){
        updateWidth();
        updateProcessedBullets();
        autoResizeTextArea('bulletInput');
    }

    
    autoResizeTextArea('bulletInput');
    document.getElementById("bulletInput").oninput = function(){
       updateProcessedBullets();
       autoResizeTextArea('bulletInput');
       //saveCookie();
    };
    document.getElementById("cookieButton").onclick = saveCookie;
    document.getElementById("outputBorder").onclick = function(e){
        if(e.detail === 4){
            selectText("outputBorder");
        }
    }
    document.getElementById("outputBorder").onkeydown = function(e){
        if(e.ctrlKey && e.keyCode == 65){
        e.preventDefault();
        //console.log('control-a')
        selectText('outputBorder')
        }
    }
    document.getElementById('resetButton').onclick = function(){
        normalizeWhiteSpace("bulletInput");
    }
    document.getElementById('importButton').onclick = importPdf;
    abbrTable.addHook('afterChange',function(){
        updateAbbrDict();
        updateProcessedBullets();

    });
    document.querySelector("#bulletInput").onmouseup = getThesaurus;
    document.querySelector("#bulletInput").onkeyup = getThesaurus;
    document.querySelector("#outputBorder").onmouseup = getThesaurus;
    document.querySelector("#outputBorder").onkeyup = getThesaurus;

    document.querySelector('#awdButton').onclick = function(){
        document.querySelector('#bulletInputSize').value = Forms.all['AF1206']['likelyWidth'].replace(/mm/,'');
        document.querySelector('#bulletInputSize').oninput();
    }
    document.querySelector('#eprButton').onclick = function(){
        document.querySelector('#bulletInputSize').value = Forms.all['AF910']['likelyWidth'].replace(/mm/,'');
        document.querySelector('#bulletInputSize').oninput();
    }
    document.querySelector('#oprButton').onclick = function(){
        document.querySelector('#bulletInputSize').value = Forms.all['AF707']['likelyWidth'].replace(/mm/,'');
        document.querySelector('#bulletInputSize').oninput();
    }

    document.querySelector('#importAbbrs').onchange = function(){importAbbrs(false)};
    importAbbrs(true);
};

</script>
</head>
<body>
    <form id="importForm" >
        <label>import from pdf: </label><input type='file' id='importPdf' name='choose pdf' accept="application/pdf">
        <button type="button" id="importButton" >import from pdf</button>
    </form>
    <form id="toolsForm">
    <div>
        <label>Form width (should not have to adjust): </label>
        <input type="number" id="bulletInputSize" name="width" min="100" max="500" step=".001">
        <button type="button" id="awdButton" >AWD</button>
        <button type="button" id="eprButton" >EPR</button>
        <button type="button" id="oprButton" >OPR</button>
    </div>
    <div style="margin:10px auto;">
        <button type="button" id="resetButton" >renormalize all spaces</button>
        <button type="button" onclick="selectText('outputBorder')">select perfected text</button>
        <button type="button" id="cookieButton" >save text</button>
    </div>
    </form>
    
    <div style="min-height:10px;overflow:auto">
        <div style="float:left">
            <div><div class="border" id="bulletsBorder">
                <textarea class='bullets' id="bulletInput">
                </textarea>
            </div></div>
            <div><div id="outputBorder" class='border' tabindex=1><!--tabindex is needed to get select thing to work--></div></div>
            <div>
                <form>
                <label>import abbrs: </label><input type='file' id='importAbbrs' name='choose abbrs' >
                <div id='abbrTable'></div>
                </form>
            </div>
        </div>
        <div id="thesaurus"></div>
    </div>
    <br>

    
</body>
</HTML>