<HTML>
<head>
    <!--This is important! needs to be UTF-8 to be compatible with adobe acceptable text-->
    <!-- python -m http.server 8021 --cgi -->
    <meta charset="UTF-8">
<title>
    Bullets Viewer
</title>
<style type="text/css">
@font-face {
  font-family: "AdobeTimes";
  src: url("./TimesNewRomanPSMT.ttf");
}
textarea.bullets{
    margin: 0px;
    height: 500px;
    white-space: pre-wrap;
    text-indent: 0px;
    overflow: hidden;
    border: none;
    padding-left: 0px;
    resize: vertical;
    /*word-break: break-all;*/
    text-rendering: geometricPrecision;
}
.border{
    border: solid black 1px;
    display: inline-block;
    margin:10px;
    vertical-align:top;
}
form{
    margin:10px
}
#processedBullets{
    display:inline-block;
    vertical-align:top;
}
.bullets{
    font-family: "AdobeTimes";
    font-size: 12pt;
    white-space:pre-wrap;
    display:inline;
    text-rendering: geometricPrecision;
}

</style>
<script type="text/javascript" src="pdf.js"></script>
<script type="text/javascript" src="import-bullets.js"></script>
<script type="text/javascript" src="bullet-fixer.js"></script>
<script type="text/javascript" src="./replaceTables.js"></script>
<script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/handsontable@7.2.2/dist/handsontable.full.min.css" rel="stylesheet" media="screen">


<script type="text/javascript">
function selectText(containerid) {
    if (document.selection) { // IE
        var range = document.body.createTextRange();
        range.moveToElementText(document.getElementById(containerid));
        range.select();
    } else if (window.getSelection) {
        var range = document.createRange();
        range.selectNode(document.getElementById(containerid));
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
    }
}
updateWidth = function(){
        newWidth = document.getElementById("bulletInputSize").value + 'mm';
        document.getElementById("bulletInput").style.width = newWidth;        
}

updateProcessedBullets = function(){
    var rawBulletStr = document.getElementById("bulletInput").value;
    var rawBullets = rawBulletStr.split('\n');
    var outputWrapper = document.getElementById('outputBorder');
    outputWrapper.innerHTML = ''; //clear out 
    
    updateDict('bulletInput');
    var optimWidth = document.getElementById("bulletInputSize").value + 'mm';

    for (bullet of rawBullets){    
        var bulletObj = new Bullet(bullet);
        var alreadyThere = bulletDict[sentence2Key(bullet)];
        
        //console.log(alreadyThere)
        if(alreadyThere && alreadyThere.optimization.width == optimWidth && alreadyThere.optimization.status >= 0){
            bulletObj.optimization = bulletDict[sentence2Key(bullet)].optimization;
            //
        }else{
            bulletObj.optimizeSpacings(optimWidth);
            bulletDict[sentence2Key(bullet)].optimization = bulletObj.optimization;
            //console.log(bulletDict[sentence2Key(bullet)])
        }
        bulletObj.post(outputWrapper);
    }
}

//technically not a cookie, but localStorage now.
function saveCookie(){
    cookieData = encodeURIComponent(
        document.getElementById('bulletInput').value
        );
    //console.log(cookieData);
    //document.cookie = cookieData +  '; expires=Thu, 18 Dec 3000 12:00:00 UTC; path=/';
    try{
        localStorage.setItem('bullets',cookieData)
        console.log("saved to local storage with character length " + cookieData.length);
    }catch(err){
        if(err.name == 'SecurityError'){
            alert("Sorry, saving to cookies does not work using the file:// interface and your browser's privacy settings")
        }else{
            throw err;
        }
    }
}


function importPdf(){
    if(!document.getElementById("importPdf").value){
        console.log('no file picked');
        return;
    }
    work = getBulletsFromPdf(document.getElementById("importPdf").files[0]);

    work.pullBullets.then(function(bullets){
        //console.log(bullets);
        
        //if I use innerHTML, the textarea doesn't update sometimes.
        // if I set the value to the bullet string, it parses it as HTML and includes things like &amp;
        // so I needed to parse it as actual HTML and get the resulting text.
        document.getElementById("bulletInput").value = 
            new DOMParser().parseFromString(bullets,'text/html').documentElement.textContent;
        //console.log(bullets)
        work.getPageInfo.then(function(data){
            console.log(data)
            document.getElementById("bulletInputSize").value = data.width.replace(/mm/,'');
            updateWidth();
            updateProcessedBullets();
        });
    });


}

window.onload = function(e){
    //This function runs when the window is finished loading. sort of like a main()

    //initialize a default width for the textarea window
    //document.getElementById("bulletInputSize").value = 202.321;
    document.getElementById("bulletInputSize").value = 202.51;
    document.getElementById("bulletInput").value = '';
    window.bulletDict = {};
    try{
        if(localStorage.getItem('bullets')){
            document.getElementById("bulletInput").value = 
                decodeURIComponent(localStorage.getItem("bullets"));
        }
    }catch(err){
        if(err.name == 'SecurityError'){
            console.log('Was not able to get localstorage bullets due to use of file interface and browser privacy settings')
        }else{
            throw err;
        }
    }

    window.hot = initTables();
    updateWidth();
    updateProcessedBullets();
    
    document.getElementById("bulletInputSize").oninput = function(){
        updateWidth();
        updateProcessedBullets();
    }
    document.getElementById("bulletInput").oninput = function(){
       updateProcessedBullets();
       //saveCookie();
    };
    document.getElementById("cookieButton").onclick = saveCookie;
    document.getElementById("outputBorder").onclick = function(e){
        if(e.detail === 4){
            selectText("outputBorder");
        }
    }
    document.getElementById("outputBorder").onkeydown = function(e){
        if(e.ctrlKey && e.keyCode == 65){
        e.preventDefault();
        //console.log('control-a')
        selectText('outputBorder')
        }
    }
    document.getElementById('resetButton').onclick = function(){
        normalizeWhiteSpace("bulletInput");
    }
    document.getElementById('importButton').onclick = importPdf;
    
};

</script>
</head>
<body>
    <form id="importForm" >
        <label>import from pdf: </label><input type='file' id='importPdf' name='choose pdf' accept="application/pdf">
        <button type="button" id="importButton" >import from pdf</button>
    </form>
    <form id="toolsForm">
    <label>Form width (should not have to adjust): </label>
    <input type="number" id="bulletInputSize" name="width" min="100" max="500" step=".001">
    <button type="button" id="resetButton" >renormalize all spaces</button>
    <button type="button" onclick="selectText('outputBorder')">select perfected text</button>
    <button type="button" id="cookieButton" >save text</button>
    </form>
    
    <div>
        <div class="border" id="bulletsBorder">
            <textarea class='bullets' id="bulletInput">
            </textarea>
        </div>
        <div id="outputBorder" class='border' tabindex=1><!--tabindex is needed to get select thing to work-->
        </div>
    </div>
    <div id='hoTable'>
    </div>
    
</body>
</HTML>